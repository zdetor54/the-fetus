{% extends "base.html" %} 

{% block page_title %} Καρτέλα Ασθενή {% endblock %}
{% block content %}

{% if current_user.is_authenticated %}

<!-- <main class="flex-shrink-0 m-auto flex-grow-1 bg-light text-dark" style="width: 100%;"> -->
<main class="flex-shrink-0 m-auto flex-grow-1 bg-dark text-light" style="width: 100%;">


    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header justify-content-center">
                    <h5 class="modal-title text-center">Επιβεβαίωση Διαγραφής</h5>
                </div>
                <div class="modal-body">
                    <p class="text-center">Είστε σίγουροι ότι θέλετε να διαγράψετε τον ασθενή;</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-outline-light px-4" data-bs-dismiss="modal">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="20" fill="currentColor" class="bi bi-x-square" viewBox="0 1 16 16">
                            <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                            <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                        </svg>
                        Ακύρωση
                    </button>
                    <button type="button" class="btn btn-danger px-4" onclick="confirmDelete()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="20" fill="currentColor" class="bi bi-trash3" viewBox="0 1 16 16">
                            <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47M8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5"/>
                        </svg>
                        Διαγραφή
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="pt-2 container px-4" id="icon-grid">
        <h2 class="zd py-2 text-center">{{ patient.first_name | proper_case}} {{ patient.last_name | proper_case}}</h2>
    </div>


    <div class="container zd">

        <!-- Row with the general history -->
        <div class=" container px-4" id="custom-cards"> 

            <!-- Row with the general history -->
            <div class="row row-cols-1 row-cols-lg-2 align-items-stretch g-4 py-3">
                
                
                <!-- Section with personal details for patient and partner -->
                <div class="col-12 col-lg-6">
                    <div class="card card-cover h-100 overflow-hidden rounded-4 shadow-lg bg-transparent">
                        <div class="d-flex flex-column h-100 text-shadow-1">

                            <!-- New content with slider card -->
                            <div class="container px-0 ">
                                <div class="form-container" style="position: relative; transition: max-height 0.2s ease-in-out;" id="formContainerPersonalDetails">

                                    <div class="read-only read-only-labels p-4" id="readOnlyContentPD">
                                        <h3 class="text-center mt-2">Προσωπικά Στοιχεία</h3>
                                        <p class="zd mt-0 pt-2">
                                            {% if patient.first_name or patient.last_name %}
                                                <span>Ονοματεπώνυμο:</span> {{ patient.first_name }} {{ patient.last_name }} <br>
                                            {% endif %}
                                            {% if patient.father_name %}
                                                <span>Πατρώνυμο:</span> {{ patient.father_name }} <br>
                                            {% endif %}
                                            {% if patient.date_of_birth %}
                                                <span>Ημερομηνία Γεννήσεως / Ηλικία:</span> {{ patient.date_of_birth }} / 
                                                {{ ((now - patient.date_of_birth).days / 365.25) | int if patient.date_of_birth else '' }} ετών<br>
                                            {% endif %}
                                            {% if patient.marital_status %}
                                                <span>Οικογενειακή Κατάσταση:</span> {{ patient.marital_status }} <br>
                                            {% endif %}
                                            {% if patient.nationality %}
                                                <span>Εθνικότητα:</span> {{ patient.nationality }} <br>
                                            {% endif %}
                                            {% if patient.occupation %}
                                                <span>Επάγγελμα:</span> {{ patient.occupation }} <br>
                                            {% endif %}
                                            {% if patient.insurance or patient.insurance_comment %}
                                                <span>Ασφάλιση:</span> {{ patient.insurance }} / {{ patient.insurance_comment }} <br>
                                            {% endif %}
                                            {% if patient.amka %}
                                                <span>AMKA:</span> {{ patient.amka }} <br>
                                            {% endif %}
                                            {% if not patient.is_active %}
                                                <span>Κατάσταση:</span> Ανενεργός
                                            {% endif %}
                                        </p>

                                        <h3 class="text-center">Στοιχεία Συντρόφου</h3>
                                        <p class="zd mt-0 pt-2">
                                            {% if patient.spouse_name %}
                                                <span>Ονοματεπώνυμο:</span> {{ patient.spouse_name }} <br>
                                            {% endif %}
                                            {% if patient.spouse_date_of_birth %}
                                                <span>Ημερομηνία Γεννήσεως / Ηλικία:</span> {{ patient.spouse_date_of_birth }} /
                                                {{ ((now - patient.spouse_date_of_birth).days / 365.25) | int if patient.spouse_date_of_birth else '' }} ετών<br>
                                            {% endif %}
                                            {% if patient.spouse_occupation %}
                                                <span>Επάγγελμα:</span> {{ patient.spouse_occupation }}
                                            {% endif %}
                                        </p>
                                        
                                        <div class="d-flex flex-wrap justify-content-end gap-2 mt-3">
                                            <button type="button" class="btn btn-outline-secondary px-4" data-edit-button="true" onclick="toggleEditModePersonalDetails()">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="20" fill="currentColor" class="bi bi-pencil-square" viewBox="0 1 16 16">
                                                    <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                                    <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                                                </svg>
                                                Επεξεργασία
                                            </button>
                                        </div>
                                    </div>


                                    <div class="editable card card-cover overflow-hidden text-bg-dark rounded-4 shadow-lg" id="editableContentPD" style="display: none;">
                                        <div class="d-flex flex-column h-100 p-3 text-shadow-1">  
                                            <div class="wrapper">
                                                <div class="form-wrapper patient-lite px-2">

                                                    {% macro input_group(field_name, field_config, value) %}
                                                    <div class="input-group">
                                                        {% if field_config.type == 'select' %}
                                                            <select id="{{ field_name }}Input" {% if not value%}class="text-muted"{% endif %}>
                                                                <option value="" class="text-muted">Επιλέξτε...</option>
                                                                {% for option in field_config.options %}
                                                                    <option value="{{ option.value }}" class="text-dark" {{ 'selected' if value == option.value else '' }}>
                                                                        {{ option.label }}
                                                                    </option>
                                                                {% endfor %}
                                                            </select>
                                                        {% else %}
                                                            <input type="{{ field_config.type }}" 
                                                                id="{{ field_name }}Input"
                                                                value="{{ value if value else '' }}">
                                                        {% endif %}
                                                        <label for="{{ field_name }}Input" class="form-label">{{ field_config.label }}:</label>
                                                    </div>
                                                    {% endmacro %}

                                                    <form>
                                                        <h2 class="text-center mt-2">Προσωπικά Στοιχεία</h2>
                                                        <!-- check box for active/inactive -->
                                                        {% if not patient.is_active %}
                                                        <div class="d-flex align-items-center justify-content-center gap-2 mb-3">
                                                            <input type="checkbox" 
                                                                id="isActiveInput" 
                                                                class="form-check-input mt-0"
                                                                {% if patient.is_active %}checked{% endif %}
                                                                value='on'
                                                                style="width: 1rem; height: 1rem;">
                                                            <label for="isActiveInput" style="color: red;">!Επανενεργοποίηση!</label>
                                                        </div>
                                                        {% endif %}

                                                        {% for field_name, field_config in personal_data_fields.items() %}
                                                            {{ input_group(field_name, field_config, getattr(patient, field_name)) }}
                                                        {% endfor %}
                                                        <!-- add date_of_birth -->
                                                        <div class="input-group">
                                                            <input type="date" 
                                                                    id="dateOfBirthInput" 
                                                                    value="{{ patient.date_of_birth if patient.date_of_birth else '' }}"
                                                                    class="{{ 'text-muted' if not patient.date_of_birth }}"
                                                                    placeholder="dd/mm/yyyy">
                                                            <label for="dateOfBirthInput" class="form-label">Ημερομηνία Γέννησης:</label>
                                                        </div>
                                                        <div class="input-group">
                                                            <select id="insuranceInput"
                                                                    {% if not patient.insurance %}
                                                                        class="text-muted"
                                                                    {% endif %}>
                                                                <option value="" class="text-muted">Επιλέξτε...</option>
                                                                <option value="ΕΟΠΥΥ" class="text-dark" {{ 'selected' if patient.insurance == 'ΕΟΠΥΥ' else '' }}>ΕΟΠΥΥ</option>
                                                                <option value="Ιδιωτική" class="text-dark" {{ 'selected' if patient.insurance == 'Ιδιωτική' else '' }}>Ιδιωτική</option>
                                                            </select>
                                                            <label for="insuranceInput" class="form-label">Ασφάλιση:</label>
                                                        </div>
                                                        <div class="input-group">
                                                            <input type="text" id="insuranceCommentInput" value="{{ patient.insurance_comment if patient.insurance_comment else '' }}" required>
                                                            <label for="insuranceCommentInput" class="form-label">Σχόλια:</label>
                                                        </div>
                                                        <div class="input-group">
                                                            <input type="text" 
                                                                   id="amkaInput" 
                                                                   value="{{ patient.amka if patient.amka else '' }}"
                                                                   placeholder="Αναζήτηση ΑΜΚΑ...">
                                                            <label for="amkaInput" class="form-label d-flex align-items-center">
                                                                AMKA:
                                                                <a href="https://www.amka.gr/AMKAGR/Default.aspx" 
                                                                   target="_blank" 
                                                                   class="ms-2">
                                                                    <svg xmlns="http://www.w3.org/2000/svg" 
                                                                         width="16" 
                                                                         height="20" 
                                                                         fill="currentColor" 
                                                                         class="bi bi-search" 
                                                                         viewBox="0 1 16 16">
                                                                        <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
                                                                    </svg>
                                                                </a>
                                                            </label>
                                                        </div>

                                                        <h2 class="text-center mt-2">Στοιχεία Συντρόφου</h2>
                                                        {% for field_name, field_config in partner_data_fields.items() %}
                                                            {{ input_group(field_name, field_config, getattr(patient, field_name)) }}
                                                        {% endfor %}
                                                        <div class="input-group">
                                                            <input type="date" 
                                                                    id="spouse_date_of_birthInput" 
                                                                    value="{{ patient.spouse_date_of_birth if patient.spouse_date_of_birth else '' }}"
                                                                    class="{{ 'text-muted' if not patient.spouse_date_of_birth }}"
                                                                    placeholder="dd/mm/yyyy">
                                                            <label for="spouse_date_of_birthInput" class="form-label">Ημερομηνία Γέννησης:</label>
                                                        </div>

                                                        <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
                                                            <button type="button" class="btn login-btn px-4" onclick="saveChangesPersonalDetails()">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="20" fill="currentColor" class="bi bi-floppy" viewBox="0 1 16 16">
                                                                    <path d="M11 2H9v3h2z"/>
                                                                    <path d="M1.5 0h11.586a1.5 1.5 0 0 1 1.06.44l1.415 1.414A1.5 1.5 0 0 1 16 2.914V14.5a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 14.5v-13A1.5 1.5 0 0 1 1.5 0M1 1.5v13a.5.5 0 0 0 .5.5H2v-4.5A1.5 1.5 0 0 1 3.5 9h9a1.5 1.5 0 0 1 1.5 1.5V15h.5a.5.5 0 0 0 .5-.5V2.914a.5.5 0 0 0-.146-.353l-1.415-1.415A.5.5 0 0 0 13.086 1H13v4.5A1.5 1.5 0 0 1 11.5 7h-7A1.5 1.5 0 0 1 3 5.5V1H1.5a.5.5 0 0 0-.5.5m3 4a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5V1H4zM3 15h10v-4.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5z"/>
                                                                </svg>
                                                                Αποθήκευση
                                                            </button>
                                                            <button type="button" class="btn btn-outline-secondary px-4" onclick="cancelChanges()">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="20" fill="currentColor" class="bi bi-x-square" viewBox="0 1 16 16">
                                                                    <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                                                                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                                                                </svg>
                                                                Ακύρωση
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>  
                                    </div>


                                </div>
                            </div>
                            <!-- end of new content with slider card -->

                        </div>
                    </div>  
                </div>
                <!-- end of section with personal details for patient and partner -->

                <!-- Section with contact details -->
                <div class="col-12 col-lg-6">
                    <div class="card card-cover h-100 overflow-hidden rounded-4 shadow-lg bg-transparent inherit-text-color">
                        <div class="d-flex flex-column h-100 text-shadow-1">

                            <!-- New content with slider card -->
                            <div class="container px-0 ">
                                <div class="form-container" style="position: relative; transition: max-height 0.2s ease-in-out;" id="formContainerContactDetails">

                                    <div class="read-only read-only-labels p-4" id="readOnlyContentCD">
                                        <h3 class="text-center mt-2">Στοιχεία Επικοινωνίας</h3>

                                        {% macro display_field(field_name, field_config, value) %}
                                            {% if value %}
                                                <span>{{ field_config.label }}:</span> {{ value }}<br>
                                            {% endif %}
                                        {% endmacro %}

                                        <p class="zd mt-0 pt-2">
                                            {% for field_name, field_config in contact_fields.items() %}
                                                {{ display_field(field_name, field_config, getattr(patient, field_name)) }}
                                            {% endfor %}
                                        </p>
                                        <div class="d-flex flex-wrap justify-content-end gap-2 mt-auto">
                                            <button type="button" class="btn btn-outline-secondary px-4" data-edit-button="true" onclick="toggleEditModeContactDetails()">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="20" fill="currentColor" class="bi bi-pencil-square" viewBox="0 1 16 16">
                                                    <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/>
                                                    <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z"/>
                                                </svg>
                                                Επεξεργασία
                                            </button>
                                        </div>
                                    </div>


                                    <div class="editable card card-cover overflow-hidden text-bg-dark rounded-4 shadow-lg" id="editableContentCD" style="display: none;">
                                        <div class="d-flex flex-column h-100 p-3 text-shadow-1">  
                                            <div class="wrapper">
                                                <div class="form-wrapper patient-lite px-2">
                                                    <form>
                                                        <h2 class="text-center mt-2">Στοιχεία Επικοινωνίας</h2>
                                                        {% for field_name, field_config in contact_fields.items() %}
                                                            {{ input_group(field_name, field_config, getattr(patient, field_name)) }}
                                                        {% endfor %}

                                                        <div class="d-flex flex-wrap justify-content-center gap-2 mt-3">
                                                            <button type="button" class="btn login-btn px-4" onclick="saveChangesContactDetails()">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="20" fill="currentColor" class="bi bi-floppy" viewBox="0 1 16 16">
                                                                    <path d="M11 2H9v3h2z"/>
                                                                    <path d="M1.5 0h11.586a1.5 1.5 0 0 1 1.06.44l1.415 1.414A1.5 1.5 0 0 1 16 2.914V14.5a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 14.5v-13A1.5 1.5 0 0 1 1.5 0M1 1.5v13a.5.5 0 0 0 .5.5H2v-4.5A1.5 1.5 0 0 1 3.5 9h9a1.5 1.5 0 0 1 1.5 1.5V15h.5a.5.5 0 0 0 .5-.5V2.914a.5.5 0 0 0-.146-.353l-1.415-1.415A.5.5 0 0 0 13.086 1H13v4.5A1.5 1.5 0 0 1 11.5 7h-7A1.5 1.5 0 0 1 3 5.5V1H1.5a.5.5 0 0 0-.5.5m3 4a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5V1H4zM3 15h10v-4.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5z"/>
                                                                </svg>
                                                                Αποθήκευση
                                                            </button>
                                                            <button type="button" class="btn btn-outline-secondary px-4" onclick="cancelChanges()">
                                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="20" fill="currentColor" class="bi bi-x-square" viewBox="0 1 16 16">
                                                                    <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                                                                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                                                                </svg>
                                                                Ακύρωση
                                                            </button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>  
                                    </div>


                                </div>
                            </div>
                            <!-- end of new content with slider card -->

                        </div>
                    </div>  
                </div>
                <!-- end of section with contact details -->

                

            </div>
            <!-- end of row with the general history -->

        </div>
    </div>

    <div class="container zd py-5" style="text-align: center;">
        <div class="container justify-content-center" style="display: inline-flex; text-align: center;">
        <ul class="nav nav-pills mb-3 bg-light p-2 secondary-nav-container" id="pills-tab" role="tablist">
            <li class="nav-item"  role="presentation">
              <button class="nav-link active" style="border-radius: 5rem;" id="pills-history_medical-tab" data-bs-toggle="pill" data-bs-target="#pills-history_medical" type="button" role="tab" aria-controls="pills-history_medical" aria-selected="true">Ιατρικό Ιστορικό</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" style="border-radius: 5rem;" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button" role="tab" aria-controls="pills-profile" aria-selected="false">Μαιευτικό Ιστορικό</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" style="border-radius: 5rem;" id="pills-contact-tab" data-bs-toggle="pill" data-bs-target="#pills-contact" type="button" role="tab" aria-controls="pills-contact" aria-selected="false">Κύηση</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" style="border-radius: 5rem;" id="pills-disabled-tab" data-bs-toggle="pill" data-bs-target="#pills-disabled" type="button" role="tab" aria-controls="pills-disabled" aria-selected="false" >Γυναικολογικό Ιστορικό</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" style="border-radius: 5rem;" id="pills-disabled-tab" data-bs-toggle="pill" data-bs-target="#pills-disabled" type="button" role="tab" aria-controls="pills-disabled" aria-selected="false">Αρχεία</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" style="border-radius: 5rem;" id="pills-disabled-tab" data-bs-toggle="pill" data-bs-target="#pills-disabled" type="button" role="tab" aria-controls="pills-disabled" aria-selected="false">Εξετάσεις</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" style="border-radius: 5rem;" id="pills-disabled-tab" data-bs-toggle="pill" data-bs-target="#pills-disabled" type="button" role="tab" aria-controls="pills-disabled" aria-selected="false">Ραντεβού</button>
            </li>
        </ul>
        </div>
          <div class="tab-content p-3" style="text-align: left;" id="pills-tabContent">
            <div class="tab-pane fade show active rounded-4 m-2" style="border-color: #EF539E;" id="pills-history_medical" role="tabpanel" aria-labelledby="pills-history_medical-tab" tabindex="0">
                <h5 class="visually-hidden">Ιατρικό Ιστορικό</h5>
                {% include 'patient_tabs/history_medical.html' %}
            </div>
            <div class="tab-pane fade" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab" tabindex="0">
                <p>Lorem ipsum dolor sit, amet consectetur adipisicing elit. Esse, quasi enim mollitia doloribus praesentium dolores aut nostrum atque. Eveniet praesentium mollitia, quasi quia maxime expedita impedit odit sed modi? Quisquam.
                    Lorem ipsum dolor sit amet, consectetur adipisicing elit. Corrupti et ipsum ratione harum ab, quia atque repellendus voluptate illo a soluta nesciunt ipsa rem necessitatibus nulla, aliquam, maxime natus nihil?
                    Lorem ipsum dolor sit amet consectetur adipisicing elit. Ipsa saepe illo ratione mollitia nobis. Impedit obcaecati itaque qui quam voluptate, iure ipsum nobis reiciendis repellendus cum quibusdam aperiam repellat dolorem!
                    Lorem ipsum dolor sit amet consectetur adipisicing elit. Nemo esse praesentium id necessitatibus iusto nesciunt sit? Nam, qui illum! Culpa et consequatur libero sequi quae inventore incidunt perferendis vero ducimus?
                    Lorem ipsum dolor sit amet consectetur adipisicing elit. Omnis accusantium voluptates, facere animi, eveniet consectetur hic veniam, dolores perferendis iusto doloremque? Eos atque veniam necessitatibus vel sapiente laboriosam quod rem.
                    Lorem ipsum dolor sit amet, consectetur adipisicing elit. Asperiores cumque fugit vero ducimus saepe unde officiis impedit, optio quisquam ullam doloribus repellat provident sunt incidunt repudiandae dignissimos mollitia placeat perspiciatis?
                </p>
            </div>
            <div class="tab-pane fade" id="pills-contact" role="tabpanel" aria-labelledby="pills-contact-tab" tabindex="0">...</div>
            <div class="tab-pane fade" id="pills-disabled" role="tabpanel" aria-labelledby="pills-disabled-tab" tabindex="0">...</div>
          </div>
        <button type="button" class="btn btn-outline-danger px-4" onclick="showDeleteModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="20" fill="currentColor" class="bi bi-trash3" viewBox="0 1 16 16">
                <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5M11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1zm1.958 1-.846 10.58a1 1 0 0 1-.997.92h-6.23a1 1 0 0 1-.997-.92L3.042 3.5zm-7.487 1a.5.5 0 0 1 .528.47l.5 8.5a.5.5 0 0 1-.998.06L5 5.03a.5.5 0 0 1 .47-.53Zm5.058 0a.5.5 0 0 1 .47.53l-.5 8.5a.5.5 0 1 1-.998-.06l.5-8.5a.5.5 0 0 1 .528-.47M8 4.5a.5.5 0 0 1 .5.5v8.5a.5.5 0 0 1-1 0V5a.5.5 0 0 1 .5-.5"/>
            </svg>
            Διαγραφή
        </button>
    </div>

    
</main>
{% else %}
    <div class="container mt-5 pt-5">
        <p class="text-danger">You are not logged in</p>
    </div>
{% endif %}

{% endblock %}

{% block javascript %}
<script>

    function showDeleteModal() {
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
        deleteModal.show();
    }

    async function confirmDelete() {
        const patientId = '{{ patient.id }}';
        try {
            const response = await fetch(`/api/patients/${patientId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) throw new Error('Delete failed');

            const data = await response.json();
            if (data.success) {
                window.location.href = '/patients';
            } else {
                throw new Error(data.error);
            }
        } catch (error) {
            console.error('Delete error:', error);
            alert('Failed to delete patient: ' + error.message);
        }
    }

    function disableAllEditButtons() {
        document.querySelectorAll('[data-edit-button="true"]').forEach(button => {
            button.disabled = true;
            button.classList.add('opacity-50');
        });
    }

    function enableAllEditButtons() {
        document.querySelectorAll('[data-edit-button="true"]').forEach(button => {
            button.disabled = false;
            button.classList.remove('opacity-50');
        });
    }
    function toggleEditModePersonalDetails() {
        const formContainer = document.getElementById('formContainerPersonalDetails');
        const readOnlyContent = document.getElementById('readOnlyContentPD');
        const editableContent = document.getElementById('editableContentPD');

        if (editableContent.style.display === 'none') {
            editableContent.style.display = 'block';
            readOnlyContent.style.display = 'none';
            formContainer.style.maxHeight = editableContent.scrollHeight + 'px';
            disableAllEditButtons();
        } else {
            editableContent.style.display = 'none';
            readOnlyContent.style.display = 'block';
            formContainer.style.maxHeight = readOnlyContent.scrollHeight + 'px';
            enableAllEditButtons();
        }
    }

    function toggleEditModeContactDetails() {
        const formContainer = document.getElementById('formContainerContactDetails');
        const readOnlyContent = document.getElementById('readOnlyContentCD');
        const editableContent = document.getElementById('editableContentCD');

        if (editableContent.style.display === 'none') {
            editableContent.style.display = 'block';
            readOnlyContent.style.display = 'none';
            formContainer.style.maxHeight = editableContent.scrollHeight + 'px';
            disableAllEditButtons();
        } else {
            editableContent.style.display = 'none';
            readOnlyContent.style.display = 'block';
            formContainer.style.maxHeight = readOnlyContent.scrollHeight + 'px';
            enableAllEditButtons();
        }
    }


    async function savePatientDetails(formContainerId) {
        try {
            const form = document.querySelector(`#${formContainerId} form`);
            if (!form) {
                console.error('Form not found:', formContainerId);
                throw new Error('Form not found');
            }

            const patientId = '{{ patient.id }}';
            const formData = {};
            
            // Fix selector syntax - use multiple querySelectorAll calls
            const elements = [...form.querySelectorAll('input'), ...form.querySelectorAll('select')];
            elements.forEach(element => {
                const fieldName = element.id.replace('Input', '');
                const snakeCase = fieldName.replace(/[A-Z]/g, letter => `_${letter.toLowerCase()}`);

                // Handle checkbox values
                if (element.type === 'checkbox') {
                    formData[snakeCase] = element.checked;
                } else {
                    formData[snakeCase] = element.value;
                }
                console.log(`Field: ${snakeCase}, Value: ${element.type === 'checkbox' ? element.checked : element.value}`); // Debug
            });

            console.log('Sending data:', formData);
            console.log('To URL:', `/api/patients/${patientId}`);

            const response = await fetch(`/api/patients/${patientId}`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }

            const data = await response.json();
            if (data.success) {
                location.reload();
            } else {
                throw new Error(data.error || 'Update failed');
            }
        } catch (error) {
            console.error('Save error:', error);
            alert(`Failed to update details: ${error.message}`);
        }
    }
    
    async function saveChangesPersonalDetails() {
        await savePatientDetails('editableContentPD');
    }

    // Section-specific handlers
    async function saveChangesContactDetails() {
        await savePatientDetails('editableContentCD');
    }

    async function cancelChanges() {
        location.reload();
    }

    

    document.addEventListener('DOMContentLoaded', () => {
    // Setup function for form containers
    const setupFormContainer = (formId, contentId) => {
        const formContainer = document.getElementById(formId);
        const readOnlyContent = document.getElementById(contentId);
        if (formContainer && readOnlyContent) {
            formContainer.style.maxHeight = readOnlyContent.scrollHeight + 'px';
        }
    };

    // Setup both containers
    setupFormContainer('formContainerPersonalDetails', 'readOnlyContentPD');
    setupFormContainer('formContainerContactDetails', 'readOnlyContentCD');
    setupFormContainer('formContainerHistoryMedical', 'readOnlyContentHistoryMedical');
    });
</script>

{{ super() }}
{% block tab_javascript %}{% endblock %}

{% endblock %}