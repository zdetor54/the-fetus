{% extends "base.html" %}

{% block page_title %} Chat με Βοηθό {% endblock %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">

  <div id="chat-container" class="text-light">
    <div id="chat-wrapper">
      <!-- Chat messages container -->
      <div id="chat-messages" class="p-3">

      </div>

      <!-- Input section -->
      <div id="chat-input-section">
        <h2 class="chat-title">Ρωτήστε για ασθενείς</h2>
        <div id="chat-input">
          <textarea
            id="user-input"
            class="form-control"
            placeholder="Γράψτε την ερώτησή σας..."
            autocomplete="off"
            rows="2"
          ></textarea>
        </div>
      </div>
    </div>
  </div>


{% endblock %}

{% block javascript %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const userInput = document.getElementById('user-input');
  const chatMessages = document.getElementById('chat-messages');
  const chatInputSection = document.getElementById('chat-input-section');

  // Check if chat is empty and position input accordingly
  function updateInputPosition(animate = false) {
    const chatTitle = document.querySelector('.chat-title');

    if (animate && chatMessages.children.length === 1) {
      // Only animate on the first message
      chatInputSection.classList.add('animating');
    }

    if (chatMessages.children.length === 0) {
      chatInputSection.style.position = 'fixed';
      chatInputSection.style.top = '40%';
      chatInputSection.style.left = '50%';
      chatInputSection.style.transform = 'translate(-50%, -50%)';
      chatInputSection.style.maxWidth = '700px';
      chatInputSection.style.width = '90%';
      if (chatTitle) chatTitle.style.display = 'block';
    } else {
      chatInputSection.style.position = 'static';
      chatInputSection.style.top = 'auto';
      chatInputSection.style.left = 'auto';
      chatInputSection.style.transform = 'none';
      chatInputSection.style.maxWidth = 'none';
      chatInputSection.style.width = '100%';
      if (chatTitle) chatTitle.style.display = 'none';
    }
  }

  // Initialize position (no animation on load)
  updateInputPosition(false);

  // Send message on Enter key
  userInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      sendMessage();
    }
  });

  async function sendMessage() {
    const question = userInput.value.trim();

    if (!question) {
      return;
    }

    // Add user message to chat
    addMessage('user', question);

    // Clear input
    userInput.value = '';

    // Update input position (move to bottom if first message, with animation)
    updateInputPosition(true);

    // Add typing indicator to chat
    const typingIndicator = addTypingIndicator();
    userInput.disabled = true;

    try {
      // Call the API
      const response = await fetch('/chat/api', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ question: question })
      });

      const data = await response.json();

      // Remove typing indicator
      typingIndicator.remove();
      userInput.disabled = false;

      if (response.ok) {
        // Add bot response
        addMessage('agent', data.answer);
      } else {
        // Show error
        addMessage('agent', 'Σφάλμα: ' + (data.error || 'Κάτι πήγε στραβά'));
      }

    } catch (error) {
      typingIndicator.remove();
      userInput.disabled = false;
      addMessage('agent', 'Σφάλμα σύνδεσης: ' + error.message);
    }
  }

  function addTypingIndicator() {
    const wrapper = document.createElement('div');
    wrapper.className = 'message-wrapper agent';
    wrapper.id = 'typing-indicator';

    const bubble = document.createElement('div');
    bubble.className = 'message-bubble bg-agent';

    const indicator = document.createElement('span');
    indicator.className = 'typing-indicator';
    indicator.innerHTML = '<span></span><span></span><span></span>';

    bubble.appendChild(indicator);
    wrapper.appendChild(bubble);
    chatMessages.appendChild(wrapper);

    // Scroll to bottom of page
    setTimeout(() => {
      window.scrollTo({
        top: document.body.scrollHeight,
        behavior: 'smooth'
      });
    }, 50);

    return wrapper;
  }

  function addMessage(type, text) {
    const wrapper = document.createElement('div');
    wrapper.className = 'message-wrapper ' + type;

    const bubble = document.createElement('div');
    bubble.className = 'message-bubble ' + (type === 'user' ? 'bg-user' : 'bg-agent');
    bubble.style.whiteSpace = 'pre-wrap';

    // Simple Markdown link parsing: [text](<url>) or [text](url)
    const html = text.replace(/\[([^\]]+)\]\(<([^>]+)>\)/g, '<a href="$2" target="_blank">$1</a>')
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
    bubble.innerHTML = html;

    wrapper.appendChild(bubble);
    chatMessages.appendChild(wrapper);

    setTimeout(() => {
      window.scrollTo({
        top: document.body.scrollHeight,
        behavior: 'smooth'
      });
    }, 50);
  }
});
</script>
{% endblock %}
