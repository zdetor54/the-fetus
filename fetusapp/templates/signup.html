{% extends "base.html" %} {% block page_title %} Διαχείριση χρήστη {% endblock
%} {% block content %}

<main class="flex-shrink-0 m-auto flex-grow-1 bg-dark">
  <div class="container zd text-light py-5" style="text-align: center;">
    <ul class="nav nav-pills mb-3 justify-content-center bg-light p-2" style="border-radius: 2rem; display: inline-flex; box-shadow: inset 1px 1px 0.2rem #3e1629;" id="pills-tab" role="tablist">
        <li class="nav-item"  role="presentation">
          <button class="nav-link {% if active_pill == 'register' %}active{% endif %}" style="border-radius: 5rem;" id="pills-register-tab" data-bs-toggle="pill" data-bs-target="#pills-register" type="button" role="tab" aria-controls="pills-register" aria-selected="true" onclick="switchTab()">Register User</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link {% if active_pill == 'update' %}active{% endif %}" style="border-radius: 5rem;" id="pills-update-tab" data-bs-toggle="pill" data-bs-target="#pills-update" type="button" role="tab" aria-controls="pills-update" aria-selected="false" onclick="switchTab()">Update User Password</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link {% if active_pill == 'delete' %}active{% endif %}" style="border-radius: 5rem;" id="pills-delete-tab" data-bs-toggle="pill" data-bs-target="#pills-delete" type="button" role="tab" aria-controls="pills-delete" aria-selected="false" onclick="switchTab()">Delete User</button>
        </li>
    </ul>
      <div class="tab-content p-3" style="text-align: left;" id="pills-tabContent">


        <!-- Register user -->
        <div class="tab-pane fade {% if active_pill == 'register' %}show active{% endif %} rounded-4 m-2" style="border-color: #EF539E;" id="pills-register" role="tabpanel" aria-labelledby="pills-home-tab" tabindex="0">
          <p class="">
            Please fill in the details of the user you want to register.
          </p>
          <form method="post" class="mt-4" id="registrationForm">
            {{form.hidden_tag()}}
            <div class="form-group mb-3">
              {{ form.username(class="form-control ", id="username",aria_describedby="usernameHelp", placeholder="Enter your username") }} 
              
              {% if form.username.errors %}
              <div class="errors">
                {% for error in form.username.errors %}
                <small id="usernameHelp" class="form-text text-muted">{{error}}</small>
                {% endfor %}
              </div>
              {% endif %}
            </div>
            <div class="row">
              <div class="col-lg-6 col-12 mb-3">
                {{ form.password(class="form-control", id="password",aria_describedby="passwordHelp", type="password", placeholder="Password") }}
                
                {% if form.password.errors %}
                <div class="errors">
                  {% for error in form.password.errors %}
                  <small id="passwordHelp" class="form-text text-muted">{{error}}</small>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
              <div class="col-lg-6 col-12 mb-3">
                {{ form.pass_confirm(class="form-control",id="pass_confirm", type="password", placeholder="Re-enter password") }}
              </div>
            </div>
            <div class="row">
              <div class="col-lg-6 col-12 mb-3">
                {{ form.first_name(class="form-control", id="first_name", type="text", placeholder="First Name") }}
              </div>
              <div class="col-lg-6 col-12 mb-3">
                {{ form.last_name(class="form-control", id="last_name", type="text", placeholder="Last Name") }}
              </div>
            </div>
            <div class="row mb-3 ">
              <div class="form-check col mx-3">
                {{ form.is_admin(class="form-check-input", id="is_admin",type="checkbox") }} 
                {{ form.is_admin.label(class="form-label") }}
              </div>
              {% with messages = get_flashed_messages() %}
                {% if messages%}
              <div class="errors">
                  {% for message in messages %}
                <small class="form-text text-muted">{{message}}</small>
                  {% endfor %}
              </div>
                {% endif %}
              {% endwith %}
            </div>
            <div class="row">
              <div class="col">
                <button type="submit" name="action" value="register" class="btn login-btn px-5">Register</button>
              </div>
            </div>
          </form>
        </div>
        <!-- End register user -->

        <!-- Update password -->
        <div class="tab-pane fade {% if active_pill == 'update' %}show active{% endif %}" id="pills-update" role="tabpanel" aria-labelledby="pills-profile-tab" tabindex="0">
          <form method="post" class="mt-4" id="updateForm">
            {{updateform.hidden_tag()}}
            <div class="form-group mb-3">
              <label for="datalistOptions" class="form-label">Select the user you want to update</label>

              {{ updateform.username(class="form-control", list="datalistOptions", id="updateUserlist", autocomplete="off", placeholder="Type to search user...", onclick="this.value='';") }}
              <datalist id="datalistOptions">
                <option value="dummy"></option>
                {%for user in users%}
                <option value="{{user.username}}">{% endfor %}</option>
              </datalist>
            </div>

            <div class="row">
              <div class="col mb-3">
                {{ updateform.old_password(class="form-control", id="old_password", aria_describedby="passwordHelp", type="password", placeholder="Type your old password") }}
              </div>
            </div>

            <!-- Update the password for the selected user -->
            <div class="row">
              <div class="col-lg-6 col-12 mb-3">
                {{ updateform.password(class="form-control", id="password", aria_describedby="passwordHelp", type="password", placeholder="Type your new password") }}
                {% if updateform.password.errors %}
                <div class="errors">
                  {% for error in updateform.password.errors %}
                  <small id="passwordHelp" class="form-text text-muted">{{error}}</small>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
              <div class="col-lg-6 col-12 mb-3">
                {{ updateform.pass_confirm(class="form-control", id="pass_confirm", type="password", placeholder="Re-enter password") }}
              </div>
            </div>

            <div class="row">
              <div class="col mb-3">
                {% if updateform.password.errors %}
                <div class="errors">
                  {% for error in updateform.password.errors %}
                  <small class="text-muted">{{error}}</small>
                  {% endfor %}
                </div>
                {% endif %} {% with messages = get_flashed_messages() %}
                {% if messages %}
                <div class="errors">
                  {% for message in messages %}
                  <small class="text-muted">{{message}}</small>
                  {% endfor %}
                </div>
                {% endif %} {% endwith %}
              </div>
            </div>

            <!-- Button trigger modal -->
            <div class="row">
              <div class="col">
                <button type="button" class="btn login-btn px-5" data-bs-toggle="modal" data-bs-target="#updateModal" id="updateUserButton" disabled>
                  Update Password
                </button>
              </div>
            </div>

            <!-- Modal -->
            <div class="modal fade" id="updateModal" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-body" id="modalBodyUpdate">
                    Are you sure you want to update this user?
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                      Cancel
                    </button>
                    <button type="submit" name="action" value="update" class="btn btn-primary" >
                      Update
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <!-- End update password -->

        <!-- Delete user -->
        <div class="tab-pane fade  {% if active_pill == 'delete' %}show active{% endif %}" id="pills-delete" role="tabpanel" aria-labelledby="pills-contact-tab" tabindex="0">
          <form method="post" id="deleteForm">
            {{deleteform.hidden_tag()}}
            <div class="form-group mb-3">
              <label for="datalistOptions" class="form-label"
                >Select the user you want to delete</label
              >
              {{ deleteform.username(class="form-control",
              list="datalistOptions", id="userlist", autocomplete="off",
              placeholder="Type to search user...",
              onclick="this.value='';") }}
              <datalist id="datalistOptions">
                <option value="dummy"></option>
                {%for user in users%}
                <option value="{{user.username}}">{% endfor %}</option>
              </datalist>
            </div>
            <div class="row mb-3">
              {% with messages = get_flashed_messages() %} {% if messages
              %}
              <div class="errors">
                {% for message in messages %}
                <small class="form-text text-muted">{{message}}</small>
                {% endfor %}
              </div>
              {% endif %} {% endwith %}
            </div>
            <!-- Button trigger modal -->
            <button
              type="button"
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#exampleModal2"
              id="deleteUserButton"
              disabled
            >
              Delete User
            </button>

            <!-- Modal -->
            <div
              class="modal fade"
              id="exampleModal2"
              tabindex="-1"
              aria-labelledby="exampleModalLabel"
              aria-hidden="true"
            >
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-body" id="modalBody">
                    Are you sure you want to delete this user?
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal"
                    >
                      Cancel
                    </button>
                    <button
                      type="submit"
                      name="action"
                      value="delete"
                      class="btn login-btn px-5"
                    >
                      Delete
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <!-- end for delete user -->
      </div>
</div>


</main>
{% endblock %} 
{% block javascript %}

<script>
  // Function to check if the update user input matches any of the datalist options
  document.addEventListener("DOMContentLoaded", function () {
    var userInput = document.getElementById("updateUserlist");
    var updateButton = document.getElementById("updateUserButton");

    // Function to check if the input matches any of the datalist options
    function validateInput() {
      var isValid = false;
      var options = document.querySelectorAll("#datalistOptions option");
      for (var i = 0; i < options.length; i++) {
        if (userInput.value === options[i].value) {
          isValid = true;
          break;
        }
      }
      updateButton.disabled = !isValid;
    }

    // Attach event listener to the user input field
    userInput.addEventListener("input", validateInput);
  });

  // Function to check if the delete user input matches any of the datalist options
  document.addEventListener("DOMContentLoaded", function () {
    var userInput = document.getElementById("userlist");
    var deleteButton = document.getElementById("deleteUserButton");

    // Function to check if the input matches any of the datalist options
    function validateInput() {
      var isValid = false;
      var options = document.querySelectorAll("#datalistOptions option");
      for (var i = 0; i < options.length; i++) {
        if (userInput.value === options[i].value) {
          isValid = true;
          break;
        }
      }
      deleteButton.disabled = !isValid;
    }

    // Attach event listener to the user input field
    userInput.addEventListener("input", validateInput);
  });

  // Attach the function to the modal trigger button
  document
    .getElementById("updateUserButton")
    .addEventListener("click", updateUpdateModalWithSelectedUser);

  // Function to update and show the modal with the selected user's name
  function updateUpdateModalWithSelectedUser() {
    var userInput = document.getElementById("updateUserlist"); // Get the input element
    var selectedUsername = userInput.value; // Get the current value of the input
    var updateModalBody = document.getElementById("modalBodyUpdate"); // Get the modal body element where you want to display the name

    // Update the modal body content
    if (selectedUsername) {
      updateModalBody.innerHTML =
        "Are you sure you want to update the password for <em>" +
        selectedUsername +
        "</em>?";
    } else {
      updateModalBody.innerHTML = "Please select a user to update!";
    }
  }

  // Attach the function to the modal trigger button
  document
    .getElementById("deleteUserButton")
    .addEventListener("click", updateDeleteModalWithSelectedUser);

  // Function to update and show the modal with the selected user's name
  function updateDeleteModalWithSelectedUser() {
    var userInput = document.getElementById("userlist"); // Get the input element
    var selectedUsername = userInput.value; // Get the current value of the input
    var modalBody = document.getElementById("modalBody"); // Get the modal body element where you want to display the name

    // Update the modal body content
    if (selectedUsername) {
      modalBody.innerHTML =
        "Are you sure you want to delete <em>" + selectedUsername + "</em>?";
    } else {
      modalBody.innerHTML = "Please select a user to delete.";
    }
  }

  // This section is to remove the flash messages when toggling between tabs
  function switchTab() {
    // Clear messages from all message containers
    $(".errors").empty();
  }
</script>

{% endblock %}
